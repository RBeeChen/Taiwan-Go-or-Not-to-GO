<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣停班停課資訊地圖 (即時資訊版)</title>
    
    <!-- Leaflet.js CSS for mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* 基本樣式，確保頁面佔滿整個視窗並設定字體 */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f2f5;
            overflow: hidden; /* 防止滾動條在側邊欄打開時出現 */
        }
        /* 地圖容器樣式，確保地圖能響應式填充空間 */
        #map {
            height: 100%;
            width: 100%;
            background-color: #a2d2ff;
        }
        /* Leaflet 彈出視窗和提示框的樣式，增加透明度和圓角 */
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
            border-radius: 8px;
        }
        .leaflet-popup-content {
            font-size: 14px;
            font-weight: 500;
            line-height: 1.6;
        }
        .leaflet-tooltip {
            background-color: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            border-radius: 4px;
            box-shadow: none;
        }
        /* 載入中旋轉圖示的樣式 */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 錯誤詳情彈出視窗的樣式 */
        #error-detail-modal {
            display: none; /* 預設隱藏 */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }
        #error-detail-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 80%; /* 響應式寬度 */
            max-width: 500px; /* 最大寬度限制 */
            position: relative;
        }
        #error-detail-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        #error-detail-close:hover,
        #error-detail-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* 側邊欄動畫和定位 */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 80%; /* 手機上側邊欄寬度 */
            max-width: 350px; /* 最大寬度限制 */
            transform: translateX(-100%); /* 預設隱藏在左側 */
            transition: transform 0.3s ease-out;
            z-index: 500; /* 高於地圖，低於 modal */
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
        }
        #sidebar.open {
            transform: translateX(0); /* 打開時滑入 */
        }
        /* 遮罩層 */
        #sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 400; /* 在地圖之上，側邊欄之下 */
            display: none; /* 預設隱藏 */
        }
        #sidebar-overlay.open {
            display: block;
        }

        /* 桌面版側邊欄樣式（覆蓋手機版固定定位） */
        @media (min-width: 768px) { /* md breakpoint */
            #sidebar {
                position: relative;
                width: 33.333333%; /* md:w-1/3 */
                max-width: none; /* 取消最大寬度限制 */
                transform: translateX(0); /* 始終顯示 */
                box-shadow: none; /* 移除陰影 */
            }
            #sidebar-overlay {
                display: none !important; /* 桌面版不顯示遮罩 */
            }
            /* 確保主內容區塊在桌面版正確佈局 */
            main {
                flex-direction: row !important;
            }
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            #sidebar {
                width: 25%; /* lg:w-1/4 */
            }
        }

        /* 漢堡選單按鈕樣式 */
        .hamburger-menu {
            display: block; /* 手機版顯示 */
            background-color: #3b82f6;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 24px; /* 調整大小 */
            line-height: 1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.2s;
        }
        .hamburger-menu:hover {
            background-color: #2563eb;
        }
        @media (min-width: 768px) {
            .hamburger-menu {
                display: none; /* 桌面版隱藏 */
            }
        }
    </style>
    <!-- Google Site Verification Tag -->
    <meta name="google-site-verification" content="SQVt1xwQIRKBvxI4TZFM-TW0bYbHJlSCztdlfJ9ckgs" />
</head>
<body class="flex flex-col h-screen">

    <!-- 頁首區塊 -->
    <header class="bg-white shadow-md z-20">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">台灣停班停課資訊地圖</h1>
                <p class="text-xs text-gray-500 mt-1">
                    地理圖資：<a href="https://github.com/RBeeChen/taiwan-typhoon-map/raw/refs/heads/main/twmap.json" target="_blank" class="text-blue-500 hover:underline">RBeeChen/taiwan-typhoon-map</a> | 
                    停班課資訊：<a href="https://www.ncdr.nat.gov.tw/" target="_blank" class="text-blue-500 hover:underline">國家災害防救科技中心</a>
                </p>
                <!-- 新增相關連結 -->
                <p class="text-xs text-gray-500 mt-1">
                    相關連結：
                    <a href="https://www.facebook.com/tw.alerts?locale=zh_TW" target="_blank" class="text-blue-500 hover:underline">Taiwan Alerts FB</a> | 
                    <a href="https://www.cwa.gov.tw/V8/C/" target="_blank" class="text-blue-500 hover:underline">中央氣象局</a>
                </p>
                <p id="update-time" class="text-xs text-gray-600 font-semibold mt-1">資料更新時間：載入中...</p>
            </div>
            <!-- 漢堡選單按鈕 (手機版顯示) -->
            <button id="sidebar-toggle-btn" class="hamburger-menu md:hidden">
                &#9776; <!-- 漢堡圖示 -->
            </button>
        </div>
    </header>

    <!-- 主要內容區塊 -->
    <main class="flex-grow flex flex-col md:flex-row overflow-hidden">
        
        <!-- 側邊資訊欄 -->
        <aside id="sidebar" class="w-full p-4 bg-gray-50 border-r border-gray-200 overflow-y-auto">
            <h2 class="text-lg font-bold text-gray-700 mb-2">詳細資訊</h2>
            <div id="info-panel" class="p-4 bg-white rounded-lg shadow min-h-[100px]">
                <p class="text-gray-600">請將滑鼠移至或點擊地圖上的縣市以查看資訊。</p>
            </div>
            <div class="mt-4">
                <h3 class="text-md font-bold text-gray-700 mb-2">圖例</h3>
                <div class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-5 h-5 rounded-md mr-2" style="background-color: #3b82f6;"></div>
                        <span class="text-sm text-gray-700">正常上班上課</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-5 h-5 rounded-md mr-2" style="background-color: #ef4444;"></div>
                        <span class="text-sm text-gray-700">全天停止上班或上課</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-5 h-5 rounded-md mr-2" style="background-color: #facc15;"></div> <!-- 黃色 -->
                        <span class="text-sm text-gray-700">非全天停止上班或上課 (例如上午、中午、下午、晚上停課)</span>
                    </div>
                     <div class="flex items-center">
                        <div class="w-5 h-5 rounded-md mr-2" style="background-color: #f97316;"></div>
                        <span class="text-sm text-gray-700">部分區域或特定人員</span>
                    </div>
                </div>
            </div>

            <!-- 離島資訊區塊 -->
            <div class="mt-6">
                <h2 class="text-lg font-bold text-gray-700 mb-2">離島資訊</h2>
                <div id="outlying-islands-info" class="p-4 bg-white rounded-lg shadow min-h-[80px]">
                    <p class="text-gray-600">正在載入離島停班停課資訊...</p>
                </div>
            </div>

            <!-- 天氣快報區塊 -->
            <div class="mt-6">
                <h2 class="text-lg font-bold text-gray-700 mb-2">天氣快報</h2>
                <div id="weather-bulletin-info" class="p-4 bg-white rounded-lg shadow min-h-[80px]">
                    <p class="text-gray-600">正在載入天氣快報資訊...</p>
                </div>
            </div>
        </aside>

        <!-- 地圖容器區塊 -->
        <section id="map-container" class="flex-grow h-full w-full relative">
            <div id="map"></div>
            <div id="map-loader" class="absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50">
                <div class="text-center">
                    <div class="spinner mx-auto"></div>
                    <p class="mt-4 text-gray-700 font-semibold">正在載入即時資料...</p>
                    <button id="show-error-btn" class="mt-4 px-4 py-2 bg-red-500 text-white rounded-md shadow-md hover:bg-red-600 transition-colors duration-200 hidden">
                        顯示錯誤詳情
                    </button>
                </div>
            </div>
        </section>

    </main>

    <!-- 側邊欄遮罩層 (手機版顯示) -->
    <div id="sidebar-overlay" class="md:hidden"></div>

    <!-- 錯誤詳情彈出視窗 -->
    <div id="error-detail-modal" class="flex">
        <div id="error-detail-content">
            <span id="error-detail-close" class="close">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4">錯誤詳情</h3>
            <p id="error-message" class="text-gray-700 font-mono text-sm whitespace-pre-wrap"></p>
        </div>
    </div>

    <!-- Leaflet.js 腳本 -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        // --- 1. 初始化地圖 ---
        // 注意：L.map() 的 setView 參數在 map.whenReady() 中會被 fitBounds 覆蓋，
        // 但為了確保地圖物件能被正確初始化，這裡仍然需要一個初始視圖。
        const map = L.map('map', {
            zoomControl: true 
        }).setView([23.9, 121], 7);
        
        // --- 2. 全域變數與 DOM 元素 ---
        let countyGeojsonLayer; // 縣市層 GeoJSON 圖層
        let townGeojson = null; // 鄉鎮層 GeoJSON 原始資料 (用於查找鄉鎮邊界)
        // affectedTownshipLayers 是一個圖層群組，用於存放所有受影響的鄉鎮圖層
        // 初始時不立即添加到地圖，等到所有圖層都準備好後再添加，以確保疊放順序
        let affectedTownshipLayers = L.layerGroup(); 

        const infoPanel = document.getElementById('info-panel');
        const updateTimeEl = document.getElementById('update-time');
        const mapLoader = document.getElementById('map-loader');
        const showErrorBtn = document.getElementById('show-error-btn');
        const errorDetailModal = document.getElementById('error-detail-modal');
        const errorMessageEl = document.getElementById('error-message');
        const errorDetailCloseBtn = document.getElementById('error-detail-close');
        const outlyingIslandsInfoEl = document.getElementById('outlying-islands-info'); // 離島資訊元素
        const weatherBulletinInfoEl = document.getElementById('weather-bulletin-info'); // 天氣快報資訊元素
        let lastErrorMessage = ''; // 儲存最後一次錯誤訊息的變數

        // 新增側邊欄相關 DOM 元素
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        let zoomControlEl; // 宣告 Leaflet 縮放控制按鈕的變數

        // 移除了資訊提示彈出視窗相關 DOM 元素

        const suspensionData = {}; // 儲存停班停課資訊，鍵可以是縣市名或縣市鄉鎮名
        // 定義需要特別顯示的離島名稱，用於從 RSS 資料中篩選 (這些通常是鄉鎮層級)
        const outlyingIslands = ['澎湖縣', '金門縣', '連江縣', '臺東縣蘭嶼鄉', '臺東縣綠島鄉'];

        // --- URL 定義 ---
        // 更新 GeoJSON URL 以反映新的 Repository 名稱
        const countyGeojsonURL = 'https://github.com/RBeeChen/taiwan-typhoon-map/raw/refs/heads/main/twmap.json'; // 縣市層級 GeoJSON
        const townGeojsonURL = 'https://github.com/RBeeChen/taiwan-typhoon-map/releases/download/JSON/TW_town.json'; // 鄉鎮層級 GeoJSON
        // 停班課資訊來源為國家災害防救科技中心 (NCDR) 的 RSS 訂閱源。
        // NCDR 整合了行政院人事行政總處等各級政府機關的發布資訊，是目前最即時且完整的停班課資料來源。
        const rssFeedURL = 'https://alerts.ncdr.nat.gov.tw/RssAtomFeed.ashx?AlertType=33';
        const cwaWarningRSSURL = 'https://www.cwa.gov.tw/rss/Data/cwa_warning.xml'; // 中央氣象局天氣快報 RSS
        // 將 CORS 代理服務更換為 corsproxy.io
        const proxyURL = 'https://corsproxy.io/?'; 

        // --- 3. 樣式邏輯 ---
        function getStyle(status) {
            const baseStyle = { weight: 1.5, opacity: 1, color: 'white', fillOpacity: 0.8 };
            switch (status) {
                case 'suspended': return { ...baseStyle, fillColor: '#ef4444' }; // 紅色：全天停止上班上課
                case 'partial_time': return { ...baseStyle, fillColor: '#facc15' }; // 黃色：非全天停止上班上課 (例如上午、中午、下午、晚上停課)
                case 'partial': return { ...baseStyle, fillColor: '#f97316' };   // 橘色：部分區域或特定人員
                case 'normal': default: return { ...baseStyle, fillColor: '#3b82f6' }; // 藍色：正常上班上課
            }
        }
        const highlightStyle = { weight: 4, color: '#333', fillOpacity: 0.95 }; // 滑鼠懸停時的邊框樣式

        // --- 4. 資料抓取與處理 ---
        // 標準化縣市/鄉鎮名稱，處理「臺」與「台」的差異，並移除括號內容
        function normalizeName(name) { 
            return name.replace('臺', '台').replace(/\(.*?\)/g, '').trim(); 
        }

        // 從 NCDR RSS 訂閱源載入停班停課資料
        async function loadSuspensionData() {
            try {
                const response = await fetch(`${proxyURL}${encodeURIComponent(rssFeedURL)}`);
                if (!response.ok) throw new Error(`RSS Feed fetch failed: ${response.status}`);
                
                const xmlString = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, "application/xml");

                // 檢查 XML 解析是否成功，如果失敗則拋出錯誤
                const parseError = xmlDoc.querySelector('parsererror');
                if (parseError) {
                    console.error("XML Parsing Error:", parseError.textContent);
                    throw new Error("Failed to parse RSS XML: " + parseError.textContent);
                }

                // 確保 xmlDoc 是一個有效的 Document 物件
                if (!(xmlDoc instanceof Document)) {
                    throw new Error("Parsed XML is not a valid Document object.");
                }

                const entries = xmlDoc.querySelectorAll('entry');

                // 再次確認 entries 是否為 NodeList，以防萬一
                if (!entries || !(entries instanceof NodeList)) {
                    throw new Error("Could not retrieve 'entry' elements from RSS feed.");
                }

                // 更新資料更新時間顯示
                const updatedTime = xmlDoc.querySelector('feed > updated')?.textContent;
                if (updatedTime) {
                    updateTimeEl.textContent = `資料更新時間：${new Date(updatedTime).toLocaleString('zh-TW')}`;
                } else {
                    updateTimeEl.textContent = `資料更新時間：無法取得`;
                }

                // 現在可以安全地遍歷 entries
                entries.forEach(entry => {
                    // 初始化 todayMatch 和 tomorrowMatch，避免在某些情況下未定義的錯誤
                    let todayMatch = null; 
                    let tomorrowMatch = null;

                    const summary = entry.querySelector('summary')?.textContent || '';
                    const cleanSummary = summary.replace(/\[.*?\]/g, '').trim(); // 移除括號內的資訊
                    if (!cleanSummary.includes(':')) return; // 如果沒有冒號分隔符則跳過

                    let [countyTownRaw, statusText] = cleanSummary.split(/:(.*)/s);
                    if (!countyTownRaw || !statusText) return;

                    countyTownRaw = countyTownRaw.trim();
                    statusText = statusText.trim();

                    if (statusText.includes('尚未列入警戒區')) return; // 跳過非警戒區域

                    let targetKey = ''; // 儲存在 suspensionData 中的鍵 (可能是縣市名或縣市鄉鎮名)
                    let parentCountyName = ''; // 所屬縣市的標準化名稱
                    let isTownshipSpecific = false; // 標記是否為鄉鎮層級的資訊

                    // 嘗試從 countyTownRaw 中提取最精確的縣市/鄉鎮名稱
                    // 1. 優先匹配完整的縣市鄉鎮名稱 (例如 "臺東縣蘭嶼鄉")
                    // 檢查是否為離島的完整名稱 (這些在 GeoJSON 中也是獨立的 Feature)
                    const foundOutlyingIsland = outlyingIslands.find(island => countyTownRaw.includes(island));
                    if (foundOutlyingIsland) {
                        targetKey = normalizeName(foundOutlyingIsland); // 使用標準化後的完整鄉鎮名作為鍵
                        isTownshipSpecific = true;
                        // 從完整離島名稱中提取所屬縣市
                        const countyMatch = foundOutlyingIsland.match(/^(.*?)(縣|市)/);
                        if (countyMatch) {
                            parentCountyName = normalizeName(countyMatch[1].trim() + countyMatch[2].trim());
                        } else {
                            // 萬一無法從離島名稱中提取縣市，則嘗試從原始字串中提取
                            parentCountyName = normalizeName(countyTownRaw.split('縣')[0].split('市')[0] + (countyTownRaw.includes('縣') ? '縣' : '市'));
                        }
                    } else {
                        // 2. 嘗試解析為一般性的「縣市鄉鎮」模式 (例如 "高雄市小港區")
                        // 這個正規表達式會匹配 "縣" 或 "市" 後面接著 "鄉", "鎮", "市", "區"
                        const townshipPattern = /(.*?)(縣|市)(.*?)(鄉|鎮|市|區)/;
                        const match = countyTownRaw.match(townshipPattern);

                        if (match) {
                            // 這是個鄉鎮層級的資訊
                            targetKey = normalizeName(countyTownRaw); // 使用標準化後的完整鄉鎮名作為鍵
                            parentCountyName = normalizeName(match[1].trim() + match[2].trim()); // 提取所屬縣市
                            isTownshipSpecific = true;
                        } else {
                            // 3. 如果以上都無法匹配，則假設是縣市層級的資訊 (例如 "高雄市")
                            targetKey = normalizeName(countyTownRaw.replace(/部分區域|災害應變中心/g, '').trim());
                            parentCountyName = targetKey; // 所屬縣市就是自己
                            isTownshipSpecific = false;
                        }
                    }
                    
                    // 確保 parentCountyName 也被標準化
                    parentCountyName = normalizeName(parentCountyName);

                    // 初始化縣市/鄉鎮的資料結構
                    const dataKey = targetKey;
                    const entryData = suspensionData[dataKey] || {
                        today: { status: 'normal', text: '今天照常上班、照常上課' },
                        tomorrow: { status: 'normal', text: '明天尚未發布資訊' }, // 預設為尚未發布
                        hasSpecificTomorrow: false,
                        isTownship: isTownshipSpecific,
                        parentCounty: parentCountyName // 儲存所屬縣市名稱
                    };

                    // --- 修正狀態判斷邏輯 ---
                    const determineStatus = (stmt) => {
                        let currentStatus = 'normal'; // 預設為正常

                        const isSuspendedKeyword = stmt.includes('停止上班') || stmt.includes('停止上課') || stmt.includes('已達停止上班及上課標準');
                        // 包含下午、晚上、中午、早上
                        const isPartialTimeSuspension = stmt.includes('下午') || stmt.includes('晚上') || stmt.includes('中午') || stmt.includes('早上');
                        const isPartialAreaOrPersonnel = stmt.includes('除了') || stmt.includes('未達') || stmt.includes('僅');

                        // 優先判斷：部分區域或特定人員 (橘色)
                        if (isPartialAreaOrPersonnel) {
                            currentStatus = 'partial'; 
                        } 
                        // 次要判斷：非全天停止上班或上課 (黃色)
                        // 必須包含停課關鍵字且有下午/晚上/中午/早上資訊，且不屬於部分區域
                        else if (isSuspendedKeyword && isPartialTimeSuspension) {
                            currentStatus = 'partial_time'; 
                        }
                        // 最後判斷：全天停止上班或上課 (紅色)
                        // 必須包含停課關鍵字，且不屬於黃色或橘色情況
                        else if (isSuspendedKeyword) { 
                            currentStatus = 'suspended'; 
                        }
                        // 如果以上都不符合，則維持 'normal' (藍色)
                        return currentStatus;
                    };


                    // 重新獲取 todayMatch 和 tomorrowMatch，確保它們在作用域內
                    todayMatch = statusText.match(/(今天[^。；]*?(停止上班|照常上班|已達停止上班及上課標準)[^。；]*?)/);
                    tomorrowMatch = statusText.match(/(明天[^。；]*?(停止上班|照常上班|已達停止上班及上課標準)[^。；]*?)/);


                    if (todayMatch && todayMatch[0]) {
                        const stmt = todayMatch[0].trim();
                        entryData.today = { status: determineStatus(stmt), text: stmt };
                    } else if (!statusText.includes('今天') && !statusText.includes('明天')) {
                        // 如果沒有明確的「今天」或「明天」語句，則將整個 statusText 視為今天的狀態
                        const stmt = statusText.trim();
                        entryData.today = { status: determineStatus(stmt), text: `今天${stmt}` }; 
                    }

                    if (tomorrowMatch && tomorrowMatch[0]) {
                        const stmt = tomorrowMatch[0].trim();
                        entryData.tomorrow = { status: determineStatus(stmt), text: stmt };
                        entryData.hasSpecificTomorrow = true;
                    } else {
                        // 如果明天沒有明確資訊，則將明天的狀態設為「尚未發布資訊」，
                        // 但其視覺顏色（如果未來有顯示明天地圖的功能）會預設為正常。
                        // info panel 和 popup 會根據 hasSpecificTomorrow 顯示「明天尚未發布資訊」
                        entryData.tomorrow = { status: 'normal', text: '明天尚未發布資訊' };
                        entryData.hasSpecificTomorrow = false;
                    }

                    suspensionData[dataKey] = entryData;

                    // 如果是鄉鎮層級的資訊，也要確保其所屬的縣市有資料，並標記該縣市有鄉鎮細部資訊
                    if (isTownshipSpecific) {
                        if (!suspensionData[parentCountyName]) {
                            suspensionData[parentCountyName] = {
                                today: { status: 'normal', text: '今天照常上班、照常上課' },
                                tomorrow: { status: 'normal', text: '明天尚未發布資訊' },
                                hasSpecificTomorrow: false,
                                isTownship: false,
                                parentCounty: parentCountyName,
                                hasTownshipSpecificData: false // 預設為 false，下面會更新
                            };
                        }
                        // 標記所屬縣市有鄉鎮細部資訊，用於地圖疊加判斷
                        suspensionData[parentCountyName].hasTownshipSpecificData = true;
                    }
                });

            } catch (error) {
                console.error("無法載入停班停課資料:", error);
                updateTimeEl.textContent = '停班課資料載入失敗，將顯示預設地圖狀態。';
                updateTimeEl.classList.add('text-red-600');
                throw error; // 重新拋出錯誤，讓 renderMap 的 catch 區塊處理
            }
        }

        // 函式：更新資訊面板內容
        function updateInfoPanel(countyName, displayName) {
            const countyInfo = suspensionData[countyName];
            let panelContent = `<h3 class="font-bold text-lg text-gray-900">${displayName}</h3>`;
            
            // 顯示縣市今天的狀態
            const todayStatusColor = getStyle(countyInfo && countyInfo.today ? countyInfo.today.status : 'normal').fillColor;
            panelContent += `<p class="mt-1 font-semibold" style="color:${todayStatusColor};">${countyInfo && countyInfo.today ? countyInfo.today.text : '今天照常上班、照常上課'}</p>`;

            // 顯示縣市明天的狀態
            const tomorrowStatusColor = getStyle(countyInfo && countyInfo.tomorrow ? countyInfo.tomorrow.status : 'normal').fillColor;
            if (countyInfo && (countyInfo.hasSpecificTomorrow || countyInfo.tomorrow.status !== 'normal')) {
                panelContent += `<p class="mt-1 font-semibold" style="color:${tomorrowStatusColor};">${countyInfo.tomorrow.text}</p>`;
            } else {
                panelContent += `<p class="mt-1 font-semibold text-gray-500">明天尚未發布資訊</p>`;
            }

            // 在面板中顯示鄉鎮受影響資訊
            if (countyInfo && countyInfo.hasTownshipSpecificData && townGeojson) {
                let townshipDetails = '';
                const filteredTownFeatures = townGeojson.features.filter(f => normalizeName(f.properties.county) === countyName);
                const affectedTownshipsInCounty = filteredTownFeatures.filter(townFeature => {
                    const townKey = normalizeName(townFeature.properties.county + townFeature.properties.town);
                    const townInfo = suspensionData[townKey];
                    return townInfo && (townInfo.today.status !== 'normal' || townInfo.tomorrow.status !== 'normal');
                });

                if (affectedTownshipsInCounty.length > 0) {
                    panelContent += `<h4 class="font-bold text-gray-700 mt-4">受影響鄉鎮資訊:</h4>`;
                    affectedTownshipsInCounty.forEach(townFeature => { 
                        const townKey = normalizeName(townFeature.properties.county + townFeature.properties.town);
                        const info = suspensionData[townKey];
                        const townTodayStatusColor = getStyle(info.today.status).fillColor;
                        const townTomorrowStatusColor = getStyle(info.tomorrow.status).fillColor;
                        townshipDetails += `<div class="mt-2 pl-4 border-l-2 border-gray-200">`;
                        // 修正：確保顯示鄉鎮名稱，如果沒有則顯示「未知鄉鎮」
                        townshipDetails += `<h4 class="font-semibold text-gray-700">${townFeature.properties.town || '未知鄉鎮'}</h4>`; 
                        townshipDetails += `<p class="text-sm" style="color:${townTodayStatusColor};">${info.today.text}</p>`;
                        if (info.hasSpecificTomorrow || info.tomorrow.status !== 'normal') {
                            townshipDetails += `<p class="text-sm" style="color:${townTomorrowStatusColor};">${info.tomorrow.text}</p>`;
                        } else {
                            townshipDetails += `<p class="text-sm text-gray-500">明天尚未發布資訊</p>`;
                        }
                        townshipDetails += `</div>`;
                    });
                    panelContent += townshipDetails;
                }
            }
            infoPanel.innerHTML = panelContent;
        }

        // 使用 GeoJSON 資料和停班停課資訊渲染地圖
        async function renderMap() {
            mapLoader.style.display = 'flex'; // 顯示載入中旋轉圖示
            showErrorBtn.classList.add('hidden'); // 初始隱藏錯誤按鈕
            lastErrorMessage = ''; // 清除之前的錯誤訊息
            
            try {
                // 首先載入停班停課資料
                await loadSuspensionData(); 
                
                // 載入縣市層級 GeoJSON 資料
                const countyResponse = await fetch(`${proxyURL}${encodeURIComponent(countyGeojsonURL)}`);
                if (!countyResponse.ok) throw new Error(`County GeoJSON fetch failed: ${countyResponse.status} - ${countyResponse.statusText}`);
                const countyData = await countyResponse.json();

                // 載入鄉鎮層級 GeoJSON 資料 (不立即添加到地圖)
                const townResponse = await fetch(`${proxyURL}${encodeURIComponent(townGeojsonURL)}`);
                if (!townResponse.ok) throw new Error(`Town GeoJSON fetch failed: ${response.status} - ${response.statusText}`);
                const townData = await townResponse.json(); // 暫時用 townData 變數接收
                townGeojson = townData; // 儲存到全域變數

                // 確保地圖已準備就緒，然後再添加圖層和設定視圖
                map.whenReady(function() {
                    // 建立 Leaflet 縣市層 GeoJSON 圖層
                    countyGeojsonLayer = L.geoJSON(countyData, {
                        style: feature => {
                            const countyName = normalizeName(feature.properties.COUNTYNAME);
                            const info = suspensionData[countyName];
                            // 地圖顏色主要反映今天的狀態，如果沒有今天資訊則預設正常
                            return getStyle(info && info.today ? info.today.status : 'normal'); 
                        },
                        onEachFeature: (feature, layer) => {
                            const countyName = normalizeName(feature.properties.COUNTYNAME); // 標準化縣市名稱
                            const displayName = feature.properties.COUNTYNAME; // 原始顯示名稱
                            layer.bindTooltip(displayName, { permanent: false, direction: 'center' }); // 滑鼠懸停時顯示提示

                            layer.on({
                                mouseover: e => {
                                    const hoveredLayer = e.target;
                                    hoveredLayer.setStyle(highlightStyle); // 滑鼠懸停時高亮顯示
                                },
                                mouseout: e => {
                                    countyGeojsonLayer.resetStyle(e.target); // 滑鼠移開時重置縣市樣式
                                },
                                click: e => {
                                    // 修正：在 fitBounds 前檢查邊界有效性
                                    const clickedBounds = e.target.getBounds();
                                    const isClickedBoundsValid = clickedBounds.isValid() && 
                                                                 !isNaN(clickedBounds.getNorth()) && !isNaN(clickedBounds.getEast()) &&
                                                                 !isNaN(clickedBounds.getSouth()) && !isNaN(clickedBounds.getWest());
                                    if (isClickedBoundsValid) {
                                        map.fitBounds(clickedBounds, { padding: [20, 20] }); // 縮放至點擊的縣市
                                    } else {
                                        console.warn("點擊的縣市 GeoJSON 邊界無效，無法縮放。");
                                    }

                                    updateInfoPanel(countyName, displayName); // 點擊時更新資訊面板

                                    const countyInfo = suspensionData[countyName];
                                    let popupContent = `<strong class="text-base">${displayName}</strong><br>`;
                                    if (countyInfo) {
                                        popupContent += `<span style="color:${getStyle(countyInfo.today.status).fillColor};">${countyInfo.today.text}</span><br>`;
                                        // 修正：只有當有明確的明天資訊且狀態非正常時才顯示明天的詳細資訊
                                        if (countyInfo.hasSpecificTomorrow && countyInfo.tomorrow.status !== 'normal') {
                                            popupContent += `<span style="color:${getStyle(countyInfo.tomorrow.status).fillColor};">${countyInfo.tomorrow.text}</span>`;
                                        } else {
                                            popupContent += `<span class="text-gray-500">明天尚未發布資訊</span>`;
                                        }

                                        // 在點擊彈出視窗中也顯示受影響鄉鎮資訊
                                        if (countyInfo.hasTownshipSpecificData && townGeojson) {
                                            const filteredTownFeatures = townGeojson.features.filter(f => normalizeName(f.properties.county) === countyName);
                                            const affectedTownshipsInCounty = filteredTownFeatures.filter(townFeature => {
                                                const townKey = normalizeName(townFeature.properties.county + townFeature.properties.town);
                                                const townInfo = suspensionData[townKey];
                                                return townInfo && (townInfo.today.status !== 'normal' || townInfo.tomorrow.status !== 'normal');
                                            });

                                            if (affectedTownshipsInCounty.length > 0) {
                                                popupContent += `<br><strong class="text-base">受影響鄉鎮:</strong>`;
                                                affectedTownshipsInCounty.forEach(townFeature => { 
                                                    const townKey = normalizeName(townFeature.properties.county + townFeature.properties.town);
                                                    const info = suspensionData[townKey];
                                                    const townTodayStatusColor = getStyle(info.today.status).fillColor;
                                                    const townTomorrowStatusColor = getStyle(info.tomorrow.status).fillColor;
                                                    // 修正：確保顯示鄉鎮名稱，如果沒有則顯示「未知鄉鎮」
                                                    popupContent += `<br><span class="ml-2 font-semibold">${townFeature.properties.town || '未知鄉鎮'}:</span>`; 
                                                    popupContent += `<br><span class="ml-4 text-sm" style="color:${townTodayStatusColor};">${info.today.text}</span>`;
                                                    if (info.hasSpecificTomorrow && info.tomorrow.status !== 'normal') {
                                                        popupContent += `<br><span class="ml-4 text-sm" style="color:${townTomorrowStatusColor};">${info.tomorrow.text}</span>`;
                                                    } else {
                                                        popupContent += `<br><span class="ml-4 text-sm text-gray-500">明天尚未發布資訊</span>`;
                                                    }
                                                });
                                            }
                                        }

                                    } else {
                                        popupContent += `<br>正常上班上課`;
                                    }
                                    L.popup().setLatLng(e.latlng).setContent(popupContent).openOn(map); // 顯示彈出視窗
                                }
                            });
                        }
                    }).addTo(map); // 先將縣市圖層添加到地圖

                    // 將地圖視野調整到縣市 GeoJSON 圖層的邊界
                    // 修正：確保 countyGeojsonLayer 存在且包含有效的圖層，其邊界才有效
                    const bounds = countyGeojsonLayer.getBounds();
                    const isValidBounds = bounds.isValid() && 
                                          !isNaN(bounds.getNorth()) && !isNaN(bounds.getEast()) &&
                                          !isNaN(bounds.getSouth()) && !isNaN(bounds.getWest());

                    if (countyGeojsonLayer && countyGeojsonLayer.getLayers().length > 0 && isValidBounds) {
                        map.fitBounds(bounds, { padding: [20, 20] });
                    } else {
                        // 如果沒有有效的 GeoJSON 資料或邊界無效，則設置一個預設視圖
                        map.setView([23.9, 121], 7); // 台灣中心點
                        console.warn("未載入有效的縣市 GeoJSON 資料或地圖邊界無效，地圖將顯示預設視圖。");
                    }

                    // 清空舊的鄉鎮圖層
                    affectedTownshipLayers.clearLayers();

                    // 直接繪製受影響的鄉鎮圖層
                    if (townGeojson) {
                        const affectedTownships = townGeojson.features.filter(f => {
                            const townKey = normalizeName(f.properties.county + f.properties.town);
                            const info = suspensionData[townKey];
                            // 只有當鄉鎮有明確的停班課資訊（非正常狀態）時才繪製
                            return info && (info.today.status !== 'normal' || info.tomorrow.status !== 'normal');
                        });

                        if (affectedTownships.length > 0) {
                            L.geoJSON(affectedTownships, {
                                style: feature => {
                                    const townKey = normalizeName(feature.properties.county + feature.properties.town);
                                    const info = suspensionData[townKey];
                                    return getStyle(info && info.today ? info.today.status : 'normal');
                                },
                                onEachFeature: (feature, layer) => {
                                    const townKey = normalizeName(feature.properties.county + feature.properties.town);
                                    const townDisplayName = feature.properties.county + feature.properties.town;
                                    const info = suspensionData[townKey];
                                    let popupContent = `<strong class="text-base">${townDisplayName}</strong><br>`;
                                    if (info) {
                                        popupContent += `<span style="color:${getStyle(info.today.status).fillColor};">${info.today.text}</span><br>`;
                                        // 修正：只有當有明確的明天資訊且狀態非正常時才顯示明天的詳細資訊
                                        if (info.hasSpecificTomorrow && info.tomorrow.status !== 'normal') {
                                            popupContent += `<span style="color:${getStyle(info.tomorrow.status).fillColor};">${info.tomorrow.text}</span>`;
                                        } else {
                                            popupContent += `<span class="text-gray-500">明天尚未發布資訊</span>`;
                                        }
                                    } else {
                                        popupContent += `正常上班上課`;
                                    }
                                    layer.bindPopup(popupContent);
                                    layer.bindTooltip(townDisplayName, { permanent: false, direction: 'center' });
                                }
                            }).addTo(affectedTownshipLayers); // 添加到鄉鎮圖層群組
                        }
                    }
                    // 將鄉鎮圖層群組添加到地圖，確保它在縣市圖層之上
                    affectedTownshipLayers.addTo(map);

                    mapLoader.style.display = 'none'; // 隱藏載入中旋轉圖示

                    // 在地圖初始化後獲取 Leaflet 縮放控制按鈕的引用
                    zoomControlEl = document.querySelector('.leaflet-control-zoom');


                    // 資料載入後渲染離島資訊
                    renderOutlyingIslandsInfo();
                    // 載入並渲染天氣快報
                    loadWeatherBulletins(); // 不需要 await，因為不阻擋地圖渲染

                    // 移除了資訊提示彈出視窗的顯示邏輯
                }); // 關閉 map.whenReady()
            } catch (error) {
                console.error("無法渲染地圖或載入資料:", error);
                lastErrorMessage = error.message; // 儲存錯誤訊息
                mapLoader.innerHTML = `
                    <div class="text-center p-4">
                        <p class="text-red-600 font-bold text-lg">地圖渲染失敗</p>
                        <p class="text-gray-700 mt-2">發生未知錯誤，請重新整理頁面。</p>
                        <button id="show-error-btn" class="mt-4 px-4 py-2 bg-red-500 text-white rounded-md shadow-md hover:bg-red-600 transition-colors duration-200">
                            顯示錯誤詳情
                        </button>
                    </div>
                `;
                // 如果按鈕被重新渲染，則重新綁定事件監聽器
                document.getElementById('show-error-btn').addEventListener('click', showErrorMessage);
            }
        }

        // 渲染離島資訊的函式
        function renderOutlyingIslandsInfo() {
            let content = '';
            outlyingIslands.forEach(island => {
                const islandInfo = suspensionData[normalizeName(island)]; // 使用 normalizeName 確保匹配
                if (islandInfo) {
                    const todayStatusColor = getStyle(islandInfo.today.status).fillColor;
                    const tomorrowStatusColor = getStyle(islandInfo.tomorrow.status).fillColor;

                    content += `
                        <div class="mb-2">
                            <h4 class="font-semibold text-gray-800">${island}</h4>
                            <p class="text-sm" style="color:${todayStatusColor};">${islandInfo.today.text}</p>
                    `;
                    // 顯示明天的狀態，如果明確提到或與今天狀態不同
                    if (islandInfo.hasSpecificTomorrow && islandInfo.tomorrow.status !== 'normal') {
                        content += `<p class="text-sm" style="color:${tomorrowStatusColor};">${islandInfo.tomorrow.text}</p>`;
                    } else { // 如果沒有明確的明天資訊或明天狀態為正常
                         content += `<p class="text-sm text-gray-500">明天尚未發布資訊</p>`;
                    }
                    content += `</div>`;
                } else {
                    // 預設為離島沒有資訊時的顯示
                    content += `
                        <div class="mb-2">
                            <h4 class="font-semibold text-gray-800">${island}</h4>
                            <p class="text-sm text-blue-600">今天照常上班、照常上課</p>
                            <p class="text-sm text-gray-500">明天尚未發布資訊</p> <!-- 這裡也改為尚未發布資訊 -->
                        </div>
                    `;
                }
            });
            if (content === '') {
                outlyingIslandsInfoEl.innerHTML = `<p class="text-gray-600">目前無離島停班停課資訊。</p>`;
            } else {
                outlyingIslandsInfoEl.innerHTML = content;
            }
        }

        // 新增載入天氣快報資料的函式
        async function loadWeatherBulletins() {
            try {
                // 注意：corsproxy.io 的使用方式是將目標 URL 放在代理 URL 後面
                const response = await fetch(`${proxyURL}${encodeURIComponent(cwaWarningRSSURL)}`);
                if (!response.ok) throw new Error(`CWA Warning RSS fetch failed: ${response.status}`);
                
                const xmlString = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, "application/xml");

                const items = xmlDoc.querySelectorAll('item');
                let content = '';
                if (items.length === 0) {
                    content = `<p class="text-gray-600">目前無天氣快報。</p>`;
                } else {
                    items.forEach(item => {
                        const title = item.querySelector('title')?.textContent || '無標題';
                        const link = item.querySelector('link')?.textContent || '#';
                        const pubDate = item.querySelector('pubDate')?.textContent;
                        let formattedDate = '';
                        if (pubDate) {
                            try {
                                // 將日期時間轉換為本地格式
                                formattedDate = new Date(pubDate).toLocaleString('zh-TW');
                            } catch (e) {
                                formattedDate = pubDate; // 如果解析失敗，則使用原始日期
                            }
                        }

                        content += `
                            <div class="mb-2 pb-2 border-b border-gray-100 last:border-b-0">
                                <a href="${link}" target="_blank" class="text-blue-600 hover:underline font-semibold">${title}</a>
                                ${formattedDate ? `<p class="text-xs text-gray-500 mt-1">${formattedDate}</p>` : ''}
                            </div>
                        `;
                    });
                }
                weatherBulletinInfoEl.innerHTML = content;

            } catch (error) {
                console.error("無法載入天氣快報資料:", error);
                weatherBulletinInfoEl.innerHTML = `<p class="text-red-600">天氣快報載入失敗。</p>`;
            }
        }

        // 顯示錯誤訊息彈出視窗的函式
        function showErrorMessage() {
            errorMessageEl.textContent = lastErrorMessage;
            errorDetailModal.style.display = 'flex'; // 顯示彈出視窗
        }

        // 「顯示錯誤詳情」按鈕的事件監聽器（初始綁定）
        // 如果載入器內容被替換，此監聽器將在 catch 區塊中重新綁定
        showErrorBtn.addEventListener('click', showErrorMessage);

        // 彈出視窗關閉按鈕的事件監聽器
        errorDetailCloseBtn.addEventListener('click', () => {
            errorDetailModal.style.display = 'none'; // 隱藏彈出視窗
        });

        // 如果使用者點擊彈出視窗外部，則隱藏彈出視窗
        window.addEventListener('click', (event) => {
            if (event.target == errorDetailModal) {
                errorDetailModal.style.display = 'none';
            }
        });

        // 移除了「了解」按鈕的事件監聽器 (資訊提示彈出視窗)

        // --- 側邊欄開關邏輯 ---
        function toggleSidebar() {
            const isOpen = sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('open');
            document.body.style.overflow = isOpen ? 'hidden' : 'auto';

            // 隱藏/顯示 Leaflet 縮放控制按鈕
            if (zoomControlEl) {
                zoomControlEl.style.display = isOpen ? 'none' : 'block';
            }

            // 強制 Leaflet 地圖重新計算尺寸，確保版面正確
            // 延遲 300ms 配合 CSS 側邊欄過渡動畫
            setTimeout(() => {
                map.invalidateSize();
            }, 300); 
        }

        // 漢堡選單按鈕事件監聽器
        sidebarToggleBtn.addEventListener('click', toggleSidebar);

        // 遮罩層點擊事件監聽器 (點擊遮罩關閉側邊欄)
        sidebarOverlay.addEventListener('click', toggleSidebar);

        // 處理視窗大小改變事件，確保桌面版側邊欄始終顯示
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) { // md breakpoint
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('open');
                document.body.style.overflow = 'auto'; // 確保桌面版可以滾動
                // 確保桌面版縮放按鈕顯示
                if (zoomControlEl) {
                    zoomControlEl.style.display = 'block';
                }
                // 桌面版尺寸變化時也重新計算地圖尺寸
                map.invalidateSize();
            }
        });

        // 新增地圖縮放事件監聽器，確保縮放後地圖尺寸正確
        map.on('zoomend', () => {
            map.invalidateSize();
        });

        // --- 5. 初始執行 ---
        renderMap();

    </script>
</body>
</html>
